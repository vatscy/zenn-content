---
title: "Xamarin に Firebase を導入する"
emoji: "🔧"
type: "tech"
topics: ["xamarin","firebase"]
published: false
---

この記事は [エムティーアイ Advent Calendar 2021](https://qiita.com/advent-calendar/2021/mti) の23日目の記事です。

-----

Xamarin プロジェクトに Firebase を導入する方法を解説します。

なお、Firebase 自体は[公式ドキュメント](https://firebase.google.com/docs)を参考に iOS/Android 用のセットアップをすればOKです。Xamarin 固有の特別な設定をする必要は特にありません。

@[card](https://firebase.google.com/docs)

# 共通セットアップ

**Firebase コンソール** > **プロジェクトの設定** > **全般** > **マイアプリ** から構成ファイルを取得します。

- iOS: `GoogleService-Info.plist`
- Android: `google-services.json`

取得した構成ファイルを iOS/Android 各プロジェクトルートに配置します。構成ファイルのビルドアクションは下記のように設定します。（Visual Studio for Mac の場合、ファイル名の右クリックメニューからビルドアクションを設定できます。）

- iOS: `BundleResource`
- Android: `GoogleServicesJson`

# Firebase Analytics

@[card](https://firebase.google.com/docs/analytics)
## NuGet パッケージの追加

NuGet から下記パッケージを追加します。

- iOS: `Xamarin.Firebase.iOS.Analytics`
    @[card](https://www.nuget.org/packages/Xamarin.Firebase.iOS.Analytics/)
- Android: `Xamarin.Firebase.Analytics`
    @[card](https://www.nuget.org/packages/Xamarin.Firebase.Analytics/)

## 初期化

## Android

`MainActivity.cs` の `OnCreate` で初期化します。

```cs:MainActivity.cs
public class MainActivity : FormsAppCompatActivity
{
    protected override void OnCreate(Bundle bundle)
    {
        //...

        // GetInstanceを呼ぶことで初期化させておく（もしかしたら不要かも）
        _ = FirebaseAnalytics.GetInstance(this);

        //...
    }
}
```

## iOS

`AppDelegate.cs` の `FinishedLaunching` で初期化します。

```cs:AppDelegate.cs
[Register(nameof(AppDelegate))]
public partial class AppDelegate : Xamarin.Forms.Platform.iOS.FormsApplicationDelegate
{
    public override bool FinishedLaunching(UIApplication app, NSDictionary options)
    {
        //...

        // Firebase共通の初期化処理
        Firebase.Core.App.Configure();

        //...
        return base.FinishedLaunching(app, options);
    }
}
```

# トラッキング

トラッキング方法について解説します。
Dependency Injection できるように `IAnalyticsService` というインタフェースを用意して実装しています。

```cs:IAnalyticsService.cs
public interface IAnalyticsService
{
    void SetUserId(string userId);
    void SetUserProperty(string name, string value);
    void TrackScreenView(string screenName, string screenClass);
    void TrackEvent(string name, IReadOnlyDictionary<string, string> properties = null);
}
```

```cs:AnalyticsService.ios.cs
sealed class AnalyticsService : IAnalyticsService
{
    public void SetUserId(string userId)
    {
        Analytics.SetUserId(userId ?? string.Empty);
        Crashlytics.SharedInstance.SetUserId(userId ?? string.Empty);
    }

    public void SetUserProperty(string name, string value)
    {
        Analytics.SetUserProperty(value, name);
    }

    public void TrackScreenView(string screenName, string screenClass)
    {
        if (!string.IsNullOrEmpty(screenName) && !string.IsNullOrEmpty(screenClass))
        {
            Analytics.SetScreenNameAndClass(screenName, screenClass);
        }
    }

    public void TrackEvent(string name, IReadOnlyDictionary<string, string> properties = null)
    {
        if (string.IsNullOrEmpty(name))
        {
            return;
        }

        var keys = new List<NSString>();
        var values = new List<NSString>();

        if (properties is object)
        {
            foreach (var item in properties)
            {
                if (!string.IsNullOrEmpty(item.Value))
                {
                    keys.Add(new NSString(item.Key));
                    values.Add(new NSString(item.Value));
                }
            }
        }

        NSDictionary<NSString, NSObject> parametersDictionary;
        if (keys.Count > 0 && values.Count > 0)
        {
            parametersDictionary = NSDictionary<NSString, NSObject>.FromObjectsAndKeys(values.ToArray(), keys.ToArray(), keys.Count);
        }
        else
        {
            parametersDictionary = new NSDictionary<NSString, NSObject>();
        }

        Analytics.LogEvent(name, parametersDictionary);
    }
}
```

```cs:AnalyticsService.android.cs
sealed class AnalyticsService : IAnalyticsService
{
    private readonly FirebaseAnalytics _analytics = FirebaseAnalytics.GetInstance(Application.Context);

    public void SetUserId(string userId)
    {
        _analytics.SetUserId(userId);
        FirebaseCrashlytics.Instance.SetUserId(userId);
    }

    public void SetUserProperty(string name, string value)
    {
        _analytics.SetUserProperty(name, value);
    }

    public void TrackScreenView(string screenName, string screenClass)
    {
        var activity = Xamarin.Essentials.Platform.CurrentActivity;
        if (!string.IsNullOrEmpty(screenName) && !string.IsNullOrEmpty(screenClass) && activity is object)
        {
            var bundle = new Bundle();
            bundle.PutString(FirebaseAnalytics.Param.ScreenName, screenName);
            bundle.PutString(FirebaseAnalytics.Param.ScreenClass, viewModel.Name);
            _analytics.LogEvent(FirebaseAnalytics.Event.ScreenView, bundle);
        }
    }

    public void TrackEvent(string name, IReadOnlyDictionary<string, string> properties)
    {
        if (string.IsNullOrEmpty(name))
        {
            return;
        }

        var p = new Bundle();
        if (properties is object)
        {
            foreach (var item in properties)
            {
                p.PutString(item.Key, item.Value);
            }
        }

        _analytics.LogEvent(name, p);
    }
}
```
