---
title: "Xamarin ã« Firebase ã‚’å°å…¥ã™ã‚‹"
emoji: "ğŸ”§"
type: "tech"
topics: ["xamarin","firebase"]
published: true
---

ã“ã®è¨˜äº‹ã¯ [ã‚¨ãƒ ãƒ†ã‚£ãƒ¼ã‚¢ã‚¤ Advent Calendar 2021](https://qiita.com/advent-calendar/2021/mti) ã®23æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
æ¥­å‹™ã‚’é€šã˜ã¦å¾—ãŸçŸ¥è¦‹ã‚’ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

-----

Xamarin ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« Firebase ã‚’å°å…¥ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

ãªãŠã€Firebase è‡ªä½“ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs)ã‚’å‚è€ƒã« iOS/Android ç”¨ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã™ã‚Œã°OKã§ã™ã€‚Xamarin å›ºæœ‰ã®ç‰¹åˆ¥ãªè¨­å®šã‚’ã™ã‚‹å¿…è¦ã¯ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚

@[card](https://firebase.google.com/docs)

# å…±é€šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

**Firebase ã‚³ãƒ³ã‚½ãƒ¼ãƒ«** > **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š** > **å…¨èˆ¬** > **ãƒã‚¤ã‚¢ãƒ—ãƒª** ã‹ã‚‰æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚

- iOS: `GoogleService-Info.plist`
- Android: `google-services.json`

å–å¾—ã—ãŸæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ iOS/Android å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«é…ç½®ã—ã¾ã™ã€‚æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ“ãƒ«ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚ï¼ˆVisual Studio for Mac ã®å ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«åã®å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã§ãã¾ã™ã€‚ï¼‰

- iOS: `BundleResource`
- Android: `GoogleServicesJson`

# Firebase Analytics

@[card](https://firebase.google.com/docs/analytics)
## NuGet ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ 

NuGet ã‹ã‚‰ä¸‹è¨˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¾ã™ã€‚

- iOS: `Xamarin.Firebase.iOS.Analytics`
    @[card](https://www.nuget.org/packages/Xamarin.Firebase.iOS.Analytics/)
- Android: `Xamarin.Firebase.Analytics`
    @[card](https://www.nuget.org/packages/Xamarin.Firebase.Analytics/)

## åˆæœŸåŒ–

### iOS

`AppDelegate.cs` ã® `FinishedLaunching` ã§åˆæœŸåŒ–ã—ã¾ã™ã€‚

```cs:AppDelegate.cs
[Register(nameof(AppDelegate))]
public partial class AppDelegate : Xamarin.Forms.Platform.iOS.FormsApplicationDelegate
{
    public override bool FinishedLaunching(UIApplication app, NSDictionary options)
    {
        //...

        // Firebaseå…±é€šã®åˆæœŸåŒ–å‡¦ç†
        Firebase.Core.App.Configure();

        //...
        return base.FinishedLaunching(app, options);
    }
}
```

### Android

`MainActivity.cs` ã® `OnCreate` ã§åˆæœŸåŒ–ã—ã¾ã™ã€‚

```cs:MainActivity.cs
public class MainActivity : FormsAppCompatActivity
{
    protected override void OnCreate(Bundle bundle)
    {
        //...

        // GetInstanceã‚’å‘¼ã¶ã“ã¨ã§åˆæœŸåŒ–ã•ã›ã¦ãŠãï¼ˆã‚‚ã—ã‹ã—ãŸã‚‰ä¸è¦ã‹ã‚‚ï¼‰
        _ = Firebase.Analytics.FirebaseAnalytics.GetInstance(this);

        //...
    }
}
```

## ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

å„ç¨®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

ã“ã“ã§ã¯ Dependency Injection ã§ãã‚‹ã‚ˆã†ã« `IAnalyticsService` ã¨ã„ã†ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”¨æ„ã—ã¦å®Ÿè£…ã™ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚ä¸è¦ã§ã‚ã‚Œã°å„ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã®ã¿å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```cs:IAnalyticsService.cs
public interface IAnalyticsService
{
    void SetUserId(string userId);
    void SetUserProperty(string name, string value);
    void TrackScreenView(string screenName, string screenClass);
    void TrackEvent(string name, IReadOnlyDictionary<string, string> properties = null);
}
```

### iOS

```cs:AnalyticsService.ios.cs
using Firebase.Analytics;

sealed class AnalyticsService : IAnalyticsService
{
    public void SetUserId(string userId)
    {
        Analytics.SetUserId(userId ?? string.Empty);
        // Crashlytics ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ä½µã›ã¦è¨­å®š
        Firebase.Crashlytics.Crashlytics.SharedInstance.SetUserId(userId ?? string.Empty);
    }

    public void SetUserProperty(string name, string value)
    {
        Analytics.SetUserProperty(value, name);
    }

    public void TrackScreenView(string screenName, string screenClass)
    {
        if (!string.IsNullOrEmpty(screenName) && !string.IsNullOrEmpty(screenClass))
        {
            Analytics.SetScreenNameAndClass(screenName, screenClass);
        }
    }

    public void TrackEvent(string name, IReadOnlyDictionary<string, string> properties = null)
    {
        if (string.IsNullOrEmpty(name))
        {
            return;
        }

        var keys = new List<NSString>();
        var values = new List<NSString>();

        if (properties is object)
        {
            foreach (var item in properties)
            {
                if (!string.IsNullOrEmpty(item.Value))
                {
                    keys.Add(new NSString(item.Key));
                    values.Add(new NSString(item.Value));
                }
            }
        }

        NSDictionary<NSString, NSObject> parametersDictionary;
        if (keys.Count > 0 && values.Count > 0)
        {
            parametersDictionary = NSDictionary<NSString, NSObject>.FromObjectsAndKeys(values.ToArray(), keys.ToArray(), keys.Count);
        }
        else
        {
            parametersDictionary = new NSDictionary<NSString, NSObject>();
        }

        Analytics.LogEvent(name, parametersDictionary);
    }
}
```

### Android

```cs:AnalyticsService.android.cs
using Firebase.Analytics;

sealed class AnalyticsService : IAnalyticsService
{
    private readonly FirebaseAnalytics _analytics = FirebaseAnalytics.GetInstance(Application.Context);

    public void SetUserId(string userId)
    {
        _analytics.SetUserId(userId);
        // Crashlytics ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ä½µã›ã¦è¨­å®š
        Firebase.Crashlytics.FirebaseCrashlytics.Instance.SetUserId(userId);
    }

    public void SetUserProperty(string name, string value)
    {
        _analytics.SetUserProperty(name, value);
    }

    public void TrackScreenView(string screenName, string screenClass)
    {
        // Activity ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã« Xamarin.Essentials ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™
        var activity = Xamarin.Essentials.Platform.CurrentActivity;
        if (!string.IsNullOrEmpty(screenName) && !string.IsNullOrEmpty(screenClass) && activity is object)
        {
            var bundle = new Bundle();
            bundle.PutString(FirebaseAnalytics.Param.ScreenName, screenName);
            bundle.PutString(FirebaseAnalytics.Param.ScreenClass, viewModel.Name);
            _analytics.LogEvent(FirebaseAnalytics.Event.ScreenView, bundle);
        }
    }

    public void TrackEvent(string name, IReadOnlyDictionary<string, string> properties)
    {
        if (string.IsNullOrEmpty(name))
        {
            return;
        }

        var p = new Bundle();
        if (properties is object)
        {
            foreach (var item in properties)
            {
                p.PutString(item.Key, item.Value);
            }
        }

        _analytics.LogEvent(name, p);
    }
}
```

# Firebase Crashlytics

@[card](https://firebase.google.com/docs/crashlytics/)

## NuGet ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ 

NuGet ã‹ã‚‰ä¸‹è¨˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¾ã™ã€‚

- iOS: `Xamarin.Firebase.iOS.Crashlytics`
    @[card](https://www.nuget.org/packages/Xamarin.Firebase.iOS.Crashlytics/)
- Android: `Xamarin.Firebase.Crashlytics`
    @[card](https://www.nuget.org/packages/Xamarin.Firebase.Crashlytics/)

## æ§‹æˆè¨­å®š

### iOS

#### dSYMè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š

iOS ã® `.csproj` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ãã€ä¸‹è¨˜è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šãƒ“ãƒ«ãƒ‰æ™‚ã«dSYMãŒè‡ªå‹•ã§Firebaseã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ï¼ˆãŸã ã—ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰æ™‚ã«ã¯ `FirebaseCrashlyticsUploadSymbolsEnabled` ã¯ `False` ã«ã—ã¦ãŠãã¨è‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚ï¼‰

```xml:Sample.iOS.csproj
<PropertyGroup>
    <FirebaseCrashlyticsUploadSymbolsEnabled>True</FirebaseCrashlyticsUploadSymbolsEnabled>
    <FirebaseCrashlyticsUploadSymbolsContinueOnError>False</FirebaseCrashlyticsUploadSymbolsContinueOnError>
</PropertyGroup>
```
### Android

#### `com.google.firebase.crashlytics.mapping_file_id` ã®è¿½åŠ 

`Resources/values/strings.xml` ã«å¿…è¦ãª string å®šç¾©ã‚’1ã¤è¿½åŠ ã—ã¾ã™ã€‚ï¼ˆã“ã‚Œã«é–¢ã—ã¦ã¯è©³ç´°ã¯ã‚¤ãƒã‚¤ãƒã‚ˆãã‚ã‹ã£ã¦ã„ãªã„ï¼‰

```xml:Resources/values/strings.xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="com.google.firebase.crashlytics.mapping_file_id">none</string>
</resources>
```

## åˆæœŸåŒ–

### iOS

`AppDelegate.cs` ã® `FinishedLaunching` ã§åˆæœŸåŒ–ã—ã¾ã™ã€‚

```cs:AppDelegate.cs
[Register(nameof(AppDelegate))]
public partial class AppDelegate : Xamarin.Forms.Platform.iOS.FormsApplicationDelegate
{
    public override bool FinishedLaunching(UIApplication app, NSDictionary options)
    {
        //...

        // Firebaseå…±é€šã®åˆæœŸåŒ–å‡¦ç†
        Firebase.Core.App.Configure();

        //...
        return base.FinishedLaunching(app, options);
    }
}
```

### Android

`MainActivity.cs` ã® `OnCreate` ã§åˆæœŸåŒ–ã—ã¾ã™ã€‚

```cs:MainActivity.cs
public class MainActivity : FormsAppCompatActivity
{
    protected override void OnCreate(Bundle bundle)
    {
        //...

        Firebase.Crashlytics.FirebaseCrashlytics.Instance.SetCrashlyticsCollectionEnabled(true);

        //...
    }
}
```

ä»¥ä¸Šã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒ­ã‚°ãŒ Firebase ã«è‡ªå‹•é€ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## éè‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã®æƒ…å ±åé›†

ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¯èƒ½ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ã‚„ç‹¬è‡ªã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã¨ã¯åŒºåˆ¥ã—ãŸã€Œéè‡´å‘½çš„ã€ãªã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦ Firebase Crashlytics ã«é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã“ã§ã¯ Dependency Injection ã§ãã‚‹ã‚ˆã†ã« `ILogService` ã¨ã„ã†ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”¨æ„ã—ã¦å®Ÿè£…ã™ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚ä¸è¦ã§ã‚ã‚Œã°å„ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã®ã¿å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```cs:ILogService.cs
public interface ILogService
{
    void Error(Exception e, [CallerMemberName] string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber] int lineNumber = -1);
    void Error(string message, [CallerMemberName] string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber] int lineNumber = -1);
}
```

### iOS

```cs:LogService.ios.cs
sealed class LogService : ILogService
{
    public void Error(Exception e, [CallerMemberName] string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber] int lineNumber = -1)
        => WriteAsError(e, "", memberName, filePath, lineNumber);

    public void Error(string message, [CallerMemberName] string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber] int lineNumber = -1)
        => WriteAsError(null, message, memberName, filePath, lineNumber);

    internal static void WriteAsError(Exception e, string message, [CallerMemberName] string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber] int lineNumber = -1)
    {
        var exception = e ?? new Exception(message);
        var fileName = System.IO.Path.GetFileName(filePath);

        var exInfo = new Dictionary<object, object>
        {
            [NSError.LocalizedDescriptionKey] = exception.Message,
            [nameof(exception.StackTrace)] = exception.StackTrace,
            ["Exception"] = exception.ToString(),
            ["Location"] = $"{memberName}({fileName}:{lineNumber})"
        };

        WriteAsError(new NSError(
            new NSString($"{fileName} line {lineNumber}"),
            -1,
            NSDictionary.FromObjectsAndKeys(exInfo.Values.ToArray(), exInfo.Keys.ToArray(), exInfo.Count)
        ));
    }

    internal static void WriteAsError(NSError e)
    {
        Firebase.Crashlytics.Crashlytics.SharedInstance.RecordError(e);
    }
}
```

### Android

```cs:LogService.android.cs
using Firebase.Crashlytics;

sealed class LogService : ILogService
{
    public void Error(Exception e, [CallerMemberName] string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber] int lineNumber = -1)
        => WriteAsError(e, "", memberName, filePath, lineNumber);

    public void Error(string message, [CallerMemberName] string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber] int lineNumber = -1)
        => WriteAsError(null, message, memberName, filePath, lineNumber);

    internal static void WriteAsError(Exception e, string message, [CallerMemberName] string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber] int lineNumber = -1)
    {
        var location = $"{memberName}({System.IO.Path.GetFileName(filePath)}:{lineNumber})";
        var throwable = e is null ? new Java.Lang.Exception(message) : Java.Lang.Throwable.FromException(e);

        FirebaseCrashlytics.Instance.Log($"Logged at {location}");
        FirebaseCrashlytics.Instance.Log(infoJson);
        FirebaseCrashlytics.Instance.RecordException(throwable);
    }
}
```

# ãŠã‚ã‚Šã«

ä»Šå›ã¯ Xamarin ã¸ã® Firebase Analytics ã¨ Firebase Crashlytics ã®å°å…¥æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚

[Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging), [Firebase Remote Config](https://firebase.google.com/docs/remote-config), [Firebase Performance Monitoring](https://firebase.google.com/docs/perf-mon), [Firebase Dynamic Links](https://firebase.google.com/docs/dynamic-links) ã®å°å…¥çµŒé¨“ã‚‚ã‚ã‚‹ãŸã‚ã€ã‚„ã‚‹æ°—ãŒå‡ºãŸã‚‰ãã®ã†ã¡æ›¸ãã¾ã™ã€‚ï¼ˆæ›¸ãã¨ã¯è¨€ã£ã¦ã„ãªã„ï¼‰
